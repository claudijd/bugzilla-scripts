#!/usr/bin/env python
import requests
import getpass
import json
import bugsy

from pdb import set_trace as bp

api_key = getpass.getpass("Enter Bugzilla API Key: ")

bugzilla = bugsy.Bugsy(api_key=api_key)
# Bugsy doesn't load depends list, so I reported in https://github.com/AutomatedTester/Bugsy/issues/51
# bug = bugzilla.get(1344762)

# Work around for not will be to load depends list via direct API calls...
bug_response = requests.get('https://bugzilla.mozilla.org/rest/bug', params={'id': '1344762', 'api_key': api_key})
bug_json = bug_response.json()
bug_depends_lists = bug_json['bugs'][0]['depends_on']

bug_metrics = []

for bug_id in bug_depends_lists:
	bug = bugzilla.get(bug_id)
	if bug.status == "RESOLVED" and bug.resolution == "FIXED":
		raw_whiteboard = bug._bug['whiteboard']
		whiteboard = dict(x.split('=') for x in raw_whiteboard.split(' '))
		bug_metrics.append({'id':bug.id, 'summary':bug.summary, 'whiteboard':whiteboard})

# Send this somewhere for further analytics/graphs/rainbows/etc.
print(json.JSONEncoder().encode(bug_metrics))
