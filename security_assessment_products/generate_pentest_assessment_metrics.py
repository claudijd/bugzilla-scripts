#!/usr/bin/env python
import bugsy
import getpass
import json

api_key = getpass.getpass("Enter Bugzilla API Key: ")

bugzilla = bugsy.Bugsy(api_key=api_key)
bugs = bugzilla.search_for\
        .product('Enterprise Information Security')\
        .component('Penetration Test')\
        .search()

severity_hist = {
  'MAXIMUM': 0,
  'HIGH': 0,
  'MEDIUM': 0,
  'LOW': 0
}

for bug in bugs:
    if bug.status == "RESOLVED" and bug.resolution == "FIXED":
        raw_whiteboard = bug._bug['whiteboard']
        whiteboard = dict(x.split('=') for x in raw_whiteboard.split(' '))
        if whiteboard.get('MAXIMUM') is not None:
            severity_hist['MAXIMUM'] += int(whiteboard.get('MAXIMUM'))
        if whiteboard.get('HIGH') is not None:
            severity_hist['HIGH'] += int(whiteboard.get('HIGH'))
        if whiteboard.get('MEDIUM') is not None:
            severity_hist['MEDIUM'] += int(whiteboard.get('MEDIUM'))
        if whiteboard.get('LOW') is not None:
            severity_hist['LOW'] += int(whiteboard.get('LOW'))

# Send this somewhere for further analytics/graphs/rainbows/etc.
print(severity_hist)